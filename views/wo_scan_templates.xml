<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <!-- Formulario simple de cierre de OT -->
  <template id="wo_finish_form">
    <t t-call="web.layout">
      <div class="oe_structure"/>
      <div class="container mt-3 mb-5">

        <h3><t t-esc="title"/></h3>
        <p><b>Producto:</b> <t t-esc="product.display_name"/></p>

        <!-- Si la OT ya está hecha, solo mostramos info -->
        <t t-if="already_done">
          <div class="alert alert-info" role="alert" style="max-width:520px">
            <p><b>Estado:</b> Terminada</p>
            <p><b>MO:</b> <t t-esc="mo_name"/></p>
            <p><b>Responsable:</b> <t t-esc="responsable_name"/></p>
            <p><b>Producido:</b> <t t-esc="produced_total"/></p>
            <p><b>Scrap:</b> <t t-esc="scrap_total"/></p>
            <p><b>Fecha/hora de cierre:</b> <t t-esc="close_dt"/></p>
          </div>
          <p>Esta orden ya fue finalizada. No se puede volver a cargar.</p>
        </t>

        <!-- Si NO está hecha, mostramos el form -->
        <t t-if="not already_done">
          <form t-att-action="'/wo/%s/finish' % wo.id" method="post" style="max-width:520px">
            <div class="mb-3">
              <label class="form-label">Piezas OK</label>
              <input type="number" name="ok_qty" class="form-control" t-att-value="ok_default" step="0.01" min="0"/>
            </div>
            <div class="mb-3">
              <label class="form-label">Piezas rechazadas</label>
              <input type="number" name="rej_qty" class="form-control" t-att-value="rej_default" step="0.01" min="0"/>
            </div>
            <button type="submit" class="btn btn-primary">Finalizar orden</button>
          </form>
        </t>

      </div>
    </t>
  </template>

  <template id="wo_finish_result">
    <t t-call="web.layout">
      <div class="container" style="max-width:720px;padding:16px">
        <t t-if="ok">
          <h3 style="color:green;">OK</h3>
        </t>
        <t t-else="">
          <h3 style="color:crimson;">Error</h3>
        </t>
        <p><t t-esc="message"/></p>

        <!-- Si tenemos data para imprimir la siguiente OT, disparar el MISMO flujo que el botón -->
        <t t-if="print_data">
          <p style="margin-top:16px;">
            Se está descargando la siguiente orden de la cola...
          </p>

          <!-- Formulario oculto que hace POST a /report/download como hace el webclient -->
          <form id="auto_print_next_wo"
                t-att-action="print_url"
                method="post"
                target="_blank"
                style="display:none;">
            <input type="hidden" name="data" t-att-value="print_data"/>
            <!-- el token es cualquier string; el controlador sólo lo devuelve como cookie -->
            <input type="hidden" name="token" value="terminal-print-token"/>
          </form>

          <script type="text/javascript">
            (function () {
              var f = document.getElementById('auto_print_next_wo');
              if (f) {
                f.submit();
              }
            })();
          </script>
        </t>
      </div>
    </t>
  </template>
</odoo>
