<?xml version="1.0" encoding="UTF-8"?>
<odoo>

  <record id="paperformat_workorder_80mm" model="report.paperformat">
    <field name="name">WO 80mm</field>
    <field name="format">custom</field>
    <field name="page_width">72</field>
    <field name="page_height">1000</field>
    <field name="orientation">Portrait</field>
    <field name="margin_top">2</field>
    <field name="margin_bottom">2</field>
    <field name="margin_left">2</field>
    <field name="margin_right">2</field>
    <field name="dpi">300</field>
  </record>

  <template id="report_workorder_80mm">
    <t t-call="web.html_container">
      <t t-call-assets="web.report_assets_common" t-js="false"/>
      <t t-foreach="docs" t-as="o">
        <div class="page"
             style="width:72mm; padding:3mm; font-size:11pt; font-family:'DejaVu Sans',sans-serif;">

          <h2 style="text-align:center; font-size:14pt; line-height:1.1; margin:0 0 2mm 0;">
            <t t-esc="o.name"/>
          </h2>

          <div style="text-align:center; margin:0 0 3mm 0;">
            <t t-esc="o.workcenter_id and o.workcenter_id.name or ''"/>
          </div>

          <div style="margin:0 0 2mm 0;">
            <b>Responsable:</b>
            <t t-esc="(o.production_id and o.production_id.user_id and o.production_id.user_id.name) or '-'"/>
          </div>

          <div style="margin:0 0 2mm 0;">
            <b>Orden de fabricacion:</b>
            <t t-esc="o.production_id.name"/>
          </div>

          <div style="margin:0 0 2mm 0;">
            <b>Producto terminado:</b><br/>
            <t t-esc="o.product_id.display_name"/>
          </div>

          <div style="margin:0 0 3mm 0;">
            <b>Cantidad por producir:</b>
            <t t-esc="o.qty_production"/> <t t-esc="o.product_uom_id.name"/>
          </div>

          <t t-if="o.move_raw_ids">
            <div style="border-top:1px dashed #000; padding-top:3mm; margin-top:2mm;">
              <b>Componentes:</b>
              <ul style="margin:0; padding-left:0; list-style:none;">
                <t t-foreach="o.move_raw_ids" t-as="m">
                  <li>- <t t-esc="m.product_id.display_name"/> - <t t-esc="m.product_uom_qty"/> <t t-esc="m.product_uom.name"/></li>
                </t>
              </ul>
            </div>
          </t>

          <!-- QR sin widgets ni campos Python: usa /report/barcode -->
          <div style="text-align:center; margin-top:6mm;">

            <!-- Construyo la URL de destino (ya URL-encodeada para meterla como value=...) -->
            <!-- '/web#id=...&model=...&view_type=form'  ==>  '/web%23id=...%26model=...%26view_type=form' -->
            <t t-set="qrtext" t-value="'/web%23id=%d%26model=mrp.workorder%26view_type=form' % o.id"/>

            <!-- Armamos el src del QR -->
            <img t-att-src="'/report/barcode/?type=QR&amp;width=256&amp;height=256&amp;value=' + qrtext"
                style="width:35mm;height:35mm;image-rendering: pixelated;-webkit-print-color-adjust: exact;"/>
          </div>
        </div>
      </t>
    </t>
  </template>

  <record id="action_report_mrp_workorder_80mm" model="ir.actions.report">
    <field name="name">Orden de Trabajo (80mm)</field>
    <field name="model">mrp.workorder</field>
    <field name="report_type">qweb-pdf</field>
    <field name="report_name">mrp_work_queue.report_workorder_80mm</field>
    <field name="paperformat_id" ref="mrp_work_queue.paperformat_workorder_80mm"/>
    <field name="binding_model_id" ref="mrp.model_mrp_workorder"/>
    <field name="binding_type">report</field>
    <field name="print_report_name">'OT_80mm_' + (object.name or '').replace('/','_')</field>
  </record>

</odoo>
